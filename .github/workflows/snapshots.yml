name: riverty-snapshots

on:
  schedule:
    - cron: '*/30 * * * *'     # alle 30 Minuten
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  snap-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare output
        run: |
          mkdir -p public/470-842-351 public/166-544-332
          printf '' > public/.nojekyll

      - name: Snapshot 470-842-351 via PhantomJsCloud
        env:
          PHANTOM_KEY: ${{ secrets.PHANTOM_KEY }}
        run: |
          JSON='{
            "url":"https://our.riverty.com/se/470-842-351",
            "renderType":"png",
            "outputAsJson":false,
            "requestSettings":{"waitInterval":5000},
            "renderSettings":{
              "viewport":{"width":1920,"height":1080},
              "clipRectangle":{"top":0,"left":0,"width":1920,"height":1080},
              "zoomFactor":1
            }
          }'
          REQ=$(printf '%s' "$JSON" | base64 -w0)
          URL="https://phantomjscloud.com/api/browser/v2/${PHANTOM_KEY}/?requestBase64=${REQ}"
          curl -fsSL "$URL" -o public/470-842-351/image.png
          # Fallback: wenn keine PNG kam, Fehler ausgeben
          file public/470-842-351/image.png | grep -qi 'PNG image' || { echo "No PNG received"; exit 1; }
          cat > public/470-842-351/index.html <<'HTML'
          <!doctype html><html lang="de"><head>
          <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
          <title>Riverty 470-842-351</title>
          <meta http-equiv="refresh" content="1800">
          <style>html,body{height:100%;margin:0;background:#000}img{position:fixed;inset:0;width:100%;height:100%;object-fit:contain;background:#000}</style>
          </head><body><img src="image.png" alt="Riverty 470-842-351"></body></html>
          HTML

      - name: Snapshot 166-544-332 via PhantomJsCloud
        env:
          PHANTOM_KEY: ${{ secrets.PHANTOM_KEY }}
        run: |
          JSON='{
            "url":"https://our.riverty.com/se/166-544-332",
            "renderType":"png",
            "outputAsJson":false,
            "requestSettings":{"waitInterval":5000},
            "renderSettings":{
              "viewport":{"width":1920,"height":1080},
              "clipRectangle":{"top":0,"left":0,"width":1920,"height":1080},
              "zoomFactor":1
            }
          }'
          REQ=$(printf '%s' "$JSON" | base64 -w0)
          URL="https://phantomjscloud.com/api/browser/v2/${PHANTOM_KEY}/?requestBase64=${REQ}"
          curl -fsSL "$URL" -o public/166-544-332/image.png
          file public/166-544-332/image.png | grep -qi 'PNG image' || { echo "No PNG received"; exit 1; }
          cat > public/166-544-332/index.html <<'HTML'
          <!doctype html><html lang="de"><head>
          <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
          <title>Riverty 166-544-332</title>
          <meta http-equiv="refresh" content="1800">
          <style>html,body{height:100%;margin:0;background:#000}img{position:fixed;inset:0;width:100%;height:100%;object-fit:contain;background:#000}</style>
          </head><body><img src="image.png" alt="Riverty 166-544-332"></body></html>
          HTML

      - name: Index page
        run: |
          cat > public/index.html <<'HTML'
          <!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
          <title>Riverty Snapshots</title>
          <style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;background:#111;color:#eee}
          a{color:#7bd}ul{line-height:1.8}</style>
          <h1>Riverty Snapshots</h1>
          <ul>
            <li><a href="./470-842-351/">470-842-351</a></li>
            <li><a href="./166-544-332/">166-544-332</a></li>
          </ul>
          HTML

      - name: Upload static artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
